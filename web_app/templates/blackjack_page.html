{% extends "bootstrap_layout.html" %}

{% block title %}{% endblock %}

{% block content %}
<h1 class="mb-4">BLACK JACK</h1>
<div class="row">
    <div class="col-md-6">
        <h3>Player Hand:</h3>
        <ul id="player-hand" class="list-group mb-3"></ul>
        <p id="player-value" class="fw-bold"></p>
    </div>
    <div class="col-md-6">
        <h3>Dealer Hand:</h3>
        <ul id="dealer-hand" class="list-group mb-3"></ul>
        <p id="dealer-value" class="fw-bold"></p>
    </div>
</div>
<p id="result" class="text-center fs-4 text-dark fw-bold"></p>
<div class="d-flex justify-content-center gap-2">
    <button id="hit" class="btn btn-dark" onclick="hit()" style="display: none;">Hit</button>
    <button id="stand" class="btn btn-danger" onclick="stand()" style="display: none;">Stand</button>
    <button id="new-game" class="btn btn-danger" onclick="startGame()">Start New Game</button>
</div>

<script>
    async function startGame() {
        try {
            document.getElementById('new-game').style.display = 'none';
            
            const response = await fetch('/start', { method: 'POST' });
            if (!response.ok) throw new Error(`Error: ${response.status}`);
            const data = await response.json();

            clearResults();

            await revealCard("player-hand", data.player_hand[0]);
            await revealCard("dealer-hand", data.dealer_hand[0]);
            await revealCard("player-hand", data.player_hand[1]);
            
            const hiddenCard = { value: "Hidden", suit: "Hidden", image: "https://deckofcardsapi.com/static/img/back.png" };
            await revealCard("dealer-hand", hiddenCard);

            updateValue("player-value", `Player Hand Value: ${data.player_value}`);
            updateValue("dealer-value", `Dealer Hand Value: -`);

            document.getElementById('hit').style.display = 'inline';
            document.getElementById('stand').style.display = 'inline';
        } catch (err) {
            console.error(err);
            alert("Failed to start the game. Check the console for more details.");
        }
    }

    async function hit() {
        try {
            const response = await fetch('/hit', { method: 'POST' });
            if (!response.ok) throw new Error(`Error: ${response.status}`);
            const data = await response.json();

            // Reveal the newly drawn card
            const newCard = data.player_hand[data.player_hand.length - 1];
            await revealCard("player-hand", newCard);

            // Update the player's hand value
            updateValue("player-value", `Player Hand Value: ${data.player_value}`);

            // If the player busted, end the game and show the result
            if (data.result) {
                document.getElementById('result').innerText = data.result;
                endGame();
            }
        } catch (err) {
            console.error(err);
            alert("Failed to hit. Check the console for more details.");
        }
    }

    async function stand() {
        try {
            const response = await fetch('/stand', { method: 'POST' });
            if (!response.ok) throw new Error(`Error: ${response.status}`);
            const data = await response.json();

            // Clear the dealer's hand and reveal all cards
            document.getElementById("dealer-hand").innerHTML = "";
            for (const card of data.dealer_hand) {
                await revealCard("dealer-hand", card);
            }

            updateValue("dealer-value", `Dealer Hand Value: ${data.dealer_value}`);
            document.getElementById('result').innerText = data.result;
            endGame();
        } catch (err) {
            console.error(err);
            alert("Failed to stand. Check the console for more details.");
        }
    }

    function updateValue(elementId, valueText) {
        document.getElementById(elementId).innerText = valueText;
    }

    async function revealCard(elementId, card) {
        const element = document.getElementById(elementId);
        const img = document.createElement("img");
        img.src = card.image;
        img.alt = `${card.value} of ${card.suit}`;
        img.className = "card-img";
        img.style.width = "100px"; // Optional: Customize card size
        img.style.marginRight = "10px";

        element.appendChild(img);

        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    function clearResults() {
        document.getElementById("player-hand").innerHTML = "";
        document.getElementById("dealer-hand").innerHTML = "";
        document.getElementById("player-value").innerText = "";
        document.getElementById("dealer-value").innerText = "";
        document.getElementById("result").innerText = "";
    }

    function endGame() {
        document.getElementById('hit').style.display = 'none';
        document.getElementById('stand').style.display = 'none';
        document.getElementById('new-game').style.display = 'inline';
    }
</script>
{% endblock %}
